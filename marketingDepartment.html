<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Marketing Department</title>
  <link rel="stylesheet" href="styles/departmentsTeam.css" />
</head>

<body>
  <header class="topbar">
    <button class="back-btn" type="button" onclick="history.back()">‚Üê Back</button>
    <h1 class="topbar__title">Marketing Department</h1>
    <div class="topbar__spacer" aria-hidden="true"></div>
  </header>

  <main class="office" id="office" aria-label="Marketing office scene"></main>

  <!-- =========================
       Tutorial overlay (first time only)
       ========================= -->
  <div class="tour is-hidden" id="tour" aria-hidden="true">
    <!-- dims (4 panels) -->
    <div class="tour__dim tour__dim--top" id="dimTop" aria-hidden="true"></div>
    <div class="tour__dim tour__dim--left" id="dimLeft" aria-hidden="true"></div>
    <div class="tour__dim tour__dim--right" id="dimRight" aria-hidden="true"></div>
    <div class="tour__dim tour__dim--bottom" id="dimBottom" aria-hidden="true"></div>

    <!-- spotlight border -->
    <div class="tour__spotlightBorder" id="tourSpotlight" aria-hidden="true"></div>

    <!-- tour card -->
    <div class="tour__card" role="dialog" aria-label="Marketing department tutorial" aria-modal="true">
      <div class="tour__title" id="tourTitle">Welcome!</div>
      <div class="tour__text" id="tourText">
        Hover or tap a team member to view their profile. Use Next to explore everyone.
      </div>

      <div class="tour__actions">
        <button class="tour__btn tour__btn--ghost" id="tourSkip" type="button">Skip</button>
        <div class="tour__spacer"></div>
        <button class="tour__btn tour__btn--ghost" id="tourBack" type="button">Back</button>
        <button class="tour__btn tour__btn--primary" id="tourNext" type="button">Next</button>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // Config
    // =========================
    const OFFICE_BG = "assets/office.jpg";
    const BODY_IMG  = "assets/body.png";

    const isTouch = window.matchMedia("(hover: none), (pointer: coarse)").matches;

    // Tour localStorage key (change version to force re-show in future)
    const TOUR_KEY = "marketing_tour_done_v4";

    // Logged-in account user name (THIS PAGE ONLY)
    const ACCOUNT_USER_NAME = "Jaden Koh";

    function escapeHtml(str = "") {
      return String(str)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    // =========================
    // Data
    // =========================
    const TEAM = [
      {
        name: "Amanda Tan",
        role: "Head of Marketing & Communications",
        contact: "amanda.tan@scape.sg | +65 6123 4001",
        intro: "Hey, I‚Äôm Amanda üëã I run marketing & comms at *SCAPE, making sure everything we do actually vibes with youth instead of feeling ‚Äúcorporate‚Äù. When I‚Äôm not in meetings, you‚Äôll probably find me caf√©-hopping, bingeing K-dramas, or scrolling TikTok for the next content idea üòÇ",
        photo: "assets/pfp-amanda.jpg",
        teamsUrl: "https://teams.microsoft.com/l/chat/0/0?users=amanda.tan@scape.sg",
        x: 15, y: 60
      },
      {
        name: "Cheryl Lim",
        role: "Marketing Analytics & Insights Executive",
        contact: "cheryl.lim@scape.sg | +65 6123 4005",
        intro: "Hey hey, I‚Äôm Cheryl üìä I‚Äôm the ‚Äúdata person‚Äù on the team, turning numbers into insights so our campaigns hit harder instead of just guessing vibes. Off-duty, I‚Äôm a matcha addict, a part-time bookworm, and a full-time Notion nerd who over-organises everything ü§ì",
        photo: "assets/pfp-cheryl.jpg",
        teamsUrl: "https://teams.microsoft.com/l/chat/0/0?users=cheryl.lim@scape.sg",
        x: 28, y: 46
      },
      {
        name: "This is you",
        role: "Intern",
        contact: "jaden.koh@scape.sg | +65 6123 4002",
        intro: "",
        photo: "assets/pfp-jaden.jpg",
        teamsUrl: "https://teams.microsoft.com/l/chat/0/0?users=jaden.koh@scape.sg",
        x: 38, y: 60
      },
      {
        name: "Nurul Afiqah Rahman",
        role: "Social Media & Community Lead",
        contact: "afiqah.rahman@scape.sg | +65 6123 4003",
        intro: "Hi, I‚Äôm Afiqah ‚ú® I live on socials for *SCAPE, from replying DMs to hyping your posts and stalking trends before they go mainstream. When I log off (rarely), I‚Äôm usually journaling, hunting for thrift finds, or dragging my friends to the latest pop-up events üõçÔ∏è",
        photo: "assets/pfp-afiqah.jpg",
        teamsUrl: "https://teams.microsoft.com/l/chat/0/0?users=afiqah.rahman@scape.sg",
        x: 65, y: 70
      },
      {
        name: "Marcus Lee",
        role: "Partnerships & Campaigns Manager",
        contact: "marcus.lee@scape.sg | +65 6123 4004",
        intro: "Hey, I‚Äôm Marcus üôå I connect *SCAPE with brands and partners so we can create collabs that are actually cool, not cringe. I‚Äôm big on basketball, streetwear drops, and late-night prata runs after events‚Äîbasically anything that involves food and good vibes üçõ",
        photo: "assets/pfp-marcus.jpg",
        teamsUrl: "https://teams.microsoft.com/l/chat/0/0?users=marcus.lee@scape.sg",
        x: 80, y: 52
      },
      {
        name: "Daniel Ong",
        role: "Events & Brand Activation Executive",
        contact: "daniel.ong@scape.sg | +65 6123 4006",
        intro: "Sup, I‚Äôm Daniel üéâ I handle on-ground events and brand activations at *SCAPE, making sure everything is IG/TikTok-worthy and not just another ‚Äústandard event‚Äù. When I‚Äôm free, I‚Äôm usually jamming on my guitar, skating around town, or testing new camera angles for event reels üé•",
        photo: "assets/pfp-daniel.jpg",
        teamsUrl: "https://teams.microsoft.com/l/chat/0/0?users=daniel.ong@scape.sg",
        x: 52, y: 50
      }
    ];

    // =========================
    // DOM refs
    // =========================
    const office = document.getElementById("office");
    office.style.backgroundImage = `url('${OFFICE_BG}')`;

    const tourEl     = document.getElementById("tour");
    const tourTitle  = document.getElementById("tourTitle");
    const tourText   = document.getElementById("tourText");
    const tourNext   = document.getElementById("tourNext");
    const tourBack   = document.getElementById("tourBack");
    const tourSkip   = document.getElementById("tourSkip");

    const dimTop     = document.getElementById("dimTop");
    const dimLeft    = document.getElementById("dimLeft");
    const dimRight   = document.getElementById("dimRight");
    const dimBottom  = document.getElementById("dimBottom");
    const spotBorder = document.getElementById("tourSpotlight");

    // =========================
    // Tooltip controls
    // =========================
    function closeAllTips() {
      document.querySelectorAll(".buddy.is-tip-open").forEach(b => {
        b.classList.remove("is-tip-open");
        b.querySelector(".buddy-tip")?.setAttribute("aria-hidden", "true");
      });
    }

    function openTeams(url) {
      window.open(url, "_blank", "noopener,noreferrer");
    }

    // =========================
    // Render buddies
    // =========================
    function renderBuddies() {
      office.innerHTML = "";

      TEAM.forEach((p, idx) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "buddy";
        btn.style.left = p.x + "%";
        btn.style.top = p.y + "%";
        btn.dataset.index = String(idx);

        btn.setAttribute(
          "aria-label",
          `Team member: ${p.name}. ${isTouch ? "Tap to view details." : "Hover to view details."}`
        );

        btn.innerHTML = `
          <!-- tooltip first -->
          <div class="buddy-tip" role="tooltip" aria-hidden="true">
            <div class="buddy-tip__name">${escapeHtml(p.name)}</div>
            <div class="buddy-tip__row"><span class="k">Role:</span> ${escapeHtml(p.role)}</div>
            <div class="buddy-tip__row"><span class="k">Contact:</span> ${escapeHtml(p.contact)}</div>
            <div class="buddy-tip__intro">${escapeHtml(p.intro)}</div>

            <button class="buddy-tip__teamsBtn" type="button"
              data-teams="${escapeHtml(p.teamsUrl)}"
              aria-label="Connect with ${escapeHtml(p.name)} on Microsoft Teams">
              <span class="teams-icon" aria-hidden="true">
                <svg viewBox="0 0 64 64" focusable="false" aria-hidden="true">
                  <path d="M8 20c0-4.4 3.6-8 8-8h20c4.4 0 8 3.6 8 8v24c0 4.4-3.6 8-8 8H16c-4.4 0-8-3.6-8-8V20z" fill="currentColor" opacity=".22"/>
                  <path d="M18 22h20v6h-7v20h-6V28h-7v-6z" fill="currentColor"/>
                  <path d="M46 26c0-3.3 2.7-6 6-6s6 2.7 6 6-2.7 6-6 6-6-2.7-6-6z" fill="currentColor" opacity=".55"/>
                  <path d="M44 36c0-2.2 1.8-4 4-4h8c2.2 0 4 1.8 4 4v8c0 2.2-1.8 4-4 4h-8c-2.2 0-4-1.8-4-4v-8z" fill="currentColor" opacity=".4"/>
                </svg>
              </span>
              <span class="buddy-tip__teamsText">Connect on Teams</span>
            </button>
          </div>

          <div class="buddy__head">
            <img class="buddy__pfp" src="${p.photo}" alt="${escapeHtml(p.name)}" />
          </div>

          <img class="buddy__body" src="${BODY_IMG}" alt="" aria-hidden="true" />
        `;

        // Mobile: tap toggles tooltip. Desktop: do nothing on click.
        btn.addEventListener("click", (e) => {
          if (e.target.closest(".buddy-tip__teamsBtn")) return;

          e.preventDefault();
          e.stopPropagation();

          if (!isTouch) return;

          const isOpen = btn.classList.contains("is-tip-open");
          closeAllTips();

          if (!isOpen) {
            btn.classList.add("is-tip-open");
            btn.querySelector(".buddy-tip")?.setAttribute("aria-hidden", "false");
          }
        });

        // Teams button opens Teams
        btn.addEventListener("click", (e) => {
          const teamsBtn = e.target.closest(".buddy-tip__teamsBtn");
          if (!teamsBtn) return;
          e.preventDefault();
          e.stopPropagation();
          const url = teamsBtn.getAttribute("data-teams");
          if (url) openTeams(url);
        });

        office.appendChild(btn);
      });
    }

    // Mobile: tap outside closes tooltip
    document.addEventListener("click", (e) => {
      if (!isTouch) return;
      const buddy = e.target.closest?.(".buddy");
      if (!buddy) closeAllTips();
    });

    // =========================
    // TOUR
    // =========================
    let TOUR_STEPS = [];
    let tourIndex = 0;

    function buildTourSteps() {
      const steps = [
        {
          title: "Welcome!",
          text:
            "This is the Marketing Department.\n" +
            "Use Next to meet everyone.\n\n" +
            "Tip: Hover (desktop) or tap (mobile) to view the profile card and connect on Teams.",
          target: null
        }
      ];

      TEAM.forEach((p, i) => {
        const isAccountUser = p.name === ACCOUNT_USER_NAME;

        steps.push({
          title: isAccountUser ? `${p.name} (You)` : p.name,
          text: isAccountUser
            ? `This is you (the logged-in account).\n\n${p.role}\n${p.contact}\n\n${p.intro}`
            : `${p.role}\n${p.contact}\n\n${p.intro}`,
          target: `.buddy[data-index="${i}"]`
        });
      });

      steps.push({
        title: "You're all set",
        text:
          "That‚Äôs the marketing team.\n" +
          "You can hover/tap anyone anytime to view their details and connect on Teams.",
        target: null,
        done: true
      });

      return steps;
    }

    function showTour() {
      document.body.classList.add("tour-active");
      tourEl.classList.remove("is-hidden");
      tourEl.setAttribute("aria-hidden", "false");
      tourIndex = 0;
      renderTourStep();
    }

    function hideTour() {
      document.body.classList.remove("tour-active");
      tourEl.classList.add("is-hidden");
      tourEl.setAttribute("aria-hidden", "true");
      clearSpotlight();
    }

    function clearSpotlight() {
      spotBorder.style.left = "-9999px";
      spotBorder.style.top = "-9999px";
      spotBorder.style.width = "0px";
      spotBorder.style.height = "0px";

      [dimTop, dimLeft, dimRight, dimBottom].forEach(d => {
        d.style.left = "-9999px";
        d.style.top = "-9999px";
        d.style.width = "0px";
        d.style.height = "0px";
      });

      document.querySelectorAll(".buddy.is-highlighted").forEach(el =>
        el.classList.remove("is-highlighted")
      );
    }

    function setSpotlightTo(selector) {
      document.querySelectorAll(".buddy.is-highlighted").forEach(el =>
        el.classList.remove("is-highlighted")
      );

      if (!selector) {
        clearSpotlight();
        return;
      }

      const el = document.querySelector(selector);
      if (!el) {
        clearSpotlight();
        return;
      }

      // Center it on screen (use instant on first step so it won't "miss" spotlight)
      el.scrollIntoView({ block: "center", inline: "center", behavior: "smooth" });

      const r = el.getBoundingClientRect();
      const pad = 12;

      const left = Math.max(8, r.left - pad);
      const top = Math.max(8, r.top - pad);
      const width = Math.min(window.innerWidth - left - 8, r.width + pad * 2);
      const height = Math.min(window.innerHeight - top - 8, r.height + pad * 2);

      const right = left + width;
      const bottom = top + height;

      // Border
      spotBorder.style.left = left + "px";
      spotBorder.style.top = top + "px";
      spotBorder.style.width = width + "px";
      spotBorder.style.height = height + "px";

      // Dims around spotlight
      dimTop.style.left = "0px";
      dimTop.style.top = "0px";
      dimTop.style.width = "100vw";
      dimTop.style.height = top + "px";

      dimLeft.style.left = "0px";
      dimLeft.style.top = top + "px";
      dimLeft.style.width = left + "px";
      dimLeft.style.height = height + "px";

      dimRight.style.left = right + "px";
      dimRight.style.top = top + "px";
      dimRight.style.width = (window.innerWidth - right) + "px";
      dimRight.style.height = height + "px";

      dimBottom.style.left = "0px";
      dimBottom.style.top = bottom + "px";
      dimBottom.style.width = "100vw";
      dimBottom.style.height = (window.innerHeight - bottom) + "px";

      el.classList.add("is-highlighted");

      // Touch: auto-open tooltip for highlighted buddy
      if (isTouch) {
        closeAllTips();
        el.classList.add("is-tip-open");
        el.querySelector(".buddy-tip")?.setAttribute("aria-hidden", "false");
      }
    }

    function renderTourStep() {
      const step = TOUR_STEPS[tourIndex];

      tourTitle.textContent = step.title;
      tourText.textContent = step.text;

      tourBack.disabled = tourIndex === 0;
      const last = tourIndex === TOUR_STEPS.length - 1;
      tourNext.textContent = last ? "Finish" : "Next";

      setSpotlightTo(step.target);

      if (step.done) localStorage.setItem(TOUR_KEY, "1");
    }

    tourNext.addEventListener("click", () => {
      const last = tourIndex === TOUR_STEPS.length - 1;
      if (!last) {
        tourIndex += 1;
        renderTourStep();
        return;
      }
      localStorage.setItem(TOUR_KEY, "1");
      hideTour();
    });

    tourBack.addEventListener("click", () => {
      if (tourIndex === 0) return;
      tourIndex -= 1;
      renderTourStep();
    });

    tourSkip.addEventListener("click", () => {
      localStorage.setItem(TOUR_KEY, "1");
      hideTour();
    });

    document.addEventListener("keydown", (e) => {
      if (tourEl.classList.contains("is-hidden")) return;

      if (e.key === "Escape") {
        localStorage.setItem(TOUR_KEY, "1");
        hideTour();
      }
      if (e.key === "Enter") {
        tourNext.click();
      }
    });

    window.addEventListener("resize", () => {
      closeAllTips();
      if (!tourEl.classList.contains("is-hidden")) {
        setSpotlightTo(TOUR_STEPS[tourIndex]?.target);
      }
    });

    renderBuddies();
    TOUR_STEPS = buildTourSteps();

    if (!localStorage.getItem(TOUR_KEY)) {
      showTour();
    }
  </script>
</body>
</html>
