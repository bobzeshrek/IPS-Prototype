<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HR Portal ‚Äî Requests</title>
  <style>
    :root{
      --orange:#FF6200;
      --black:#0D0D0D;
      --bg:#f6f7fb;
      --card:#ffffff;
      --border: rgba(13,13,13,.12);
      --shadow: 0 10px 25px rgba(0,0,0,.08);
      --radius: 18px;
      --muted: rgba(13,13,13,.65);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--black);
    }

    /* ===== Header ===== */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 100;
      height: 56px;
      padding: 0 16px;
      width: 100%;
      background: var(--black);
      color: #fff;
      box-shadow: 0 2px 10px rgba(0,0,0,.18);

      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
    }
    .topbar__title{
      margin: 0;
      font-size: 18px;
      font-weight: 900;
      text-align: center;
      letter-spacing: .2px;
    }
    .topbar__left{ justify-self:start; display:flex; gap:10px; align-items:center; }
    .topbar__right{ justify-self:end; display:flex; gap:10px; align-items:center; }

    .btn{
      border: 0;
      border-radius: 12px;
      padding: 8px 12px;
      font-weight: 900;
      cursor: pointer;
    }
    .btn--ghost{
      background: rgba(255,255,255,.12);
      color:#fff;
      border: 1px solid rgba(255,255,255,.18);
    }
    .btn--ghost:hover{ background: rgba(255,255,255,.16); }

    .pill{
      font-size: 12px;
      font-weight: 900;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      white-space: nowrap;
    }

    /* ===== Page ===== */
    .page{
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px 16px 80px;
    }

    .header-row{
      display:flex;
      align-items:flex-end;
      justify-content: space-between;
      gap: 12px;
      margin: 10px 0 14px;
      flex-wrap: wrap;
    }

    .h2{
      margin:0;
      font-size: 20px;
      font-weight: 950;
    }
    .sub{
      margin: 4px 0 0;
      color: var(--muted);
      font-size: 13px;
      max-width: 720px;
      line-height: 1.35;
    }

    /* ===== Filters ===== */
    .filters{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
    }
    .filter{
      border: 1px solid rgba(13,13,13,.14);
      background:#fff;
      border-radius: 999px;
      padding: 8px 12px;
      font-weight: 900;
      font-size: 13px;
      cursor:pointer;
      box-shadow: 0 6px 16px rgba(0,0,0,.06);
      display:flex;
      gap:8px;
      align-items:center;
    }
    .filter.is-active{
      border-color: rgba(255,98,0,.45);
      box-shadow: 0 0 0 3px rgba(255,98,0,.16);
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: rgba(13,13,13,.25);
    }
    .dot.pending{ background: rgba(255,98,0,.9); }
    .dot.approved{ background: rgba(0,180,90,.9); }
    .dot.declined{ background: rgba(230,50,50,.9); }

    /* ===== Grid of tickets ===== */
    .grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 14px;
      margin-top: 14px;
    }
    @media (max-width: 940px){
      .grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    @media (max-width: 560px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      display:flex;
      flex-direction: column;
      gap: 10px;
      min-height: 160px;
    }
    .card:hover{
      transform: translateY(-2px);
      border-color: rgba(13,13,13,.22);
      box-shadow: 0 14px 34px rgba(0,0,0,.10);
    }

    .card__top{
      display:flex;
      justify-content: space-between;
      align-items:flex-start;
      gap: 10px;
    }
    .ticket-id{
      font-weight: 950;
      font-size: 13px;
    }
    .status{
      font-size: 12px;
      font-weight: 950;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(13,13,13,.12);
      background: rgba(13,13,13,.04);
      white-space: nowrap;
    }
    .status.pending{
      background: rgba(255,98,0,.10);
      border-color: rgba(255,98,0,.22);
    }
    .status.approved{
      background: rgba(0,180,90,.10);
      border-color: rgba(0,180,90,.22);
    }
    .status.declined{
      background: rgba(230,50,50,.10);
      border-color: rgba(230,50,50,.22);
    }

    .who{
      font-weight: 950;
      font-size: 15px;
      margin: 0;
    }
    .meta{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
    }

    .change{
      border-top: 1px dashed rgba(13,13,13,.14);
      padding-top: 10px;
      display:flex;
      flex-direction: column;
      gap: 6px;
    }
    .change__row{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      font-size: 13px;
    }
    .k{ font-weight: 950; color: rgba(13,13,13,.70); }

    .empty{
      margin-top: 18px;
      padding: 18px;
      border-radius: 18px;
      border: 1px dashed rgba(13,13,13,.18);
      background: #fff;
      color: rgba(13,13,13,.75);
    }

    /* ===== Modal ===== */
    .modal.is-hidden{ display:none; }
    .modal{
      position: fixed;
      inset:0;
      z-index: 9999;
      display:grid;
      place-items:center;
      padding: 18px;
    }
    .modal__overlay{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.55);
    }
    .modal__panel{
      position: relative;
      width: min(520px, 100%);
      border-radius: 18px;
      overflow:hidden;
      background: #fff;
      border: 1px solid rgba(13,13,13,.14);
      box-shadow: 0 24px 70px rgba(0,0,0,.35);
    }
    .modal__header{
      background: var(--black);
      color:#fff;
      padding: 12px 14px;
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
    }
    .modal__title{
      margin:0;
      font-weight: 950;
      font-size: 16px;
    }
    .icon-btn{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: 0;
      background: rgba(255,255,255,.14);
      color: #fff;
      cursor:pointer;
      font-weight: 950;
    }
    .icon-btn:hover{ background: rgba(255,255,255,.22); }

    .bubble{ padding: 14px; }
    .bubble__section{
      border: 1px solid rgba(13,13,13,.10);
      border-radius: 16px;
      padding: 12px;
      background: rgba(255,98,0,.05);
      margin-bottom: 12px;
    }
    .bubble__h{
      font-weight: 950;
      margin: 0 0 8px;
      font-size: 13px;
      color: rgba(13,13,13,.70);
    }
    .bubble__line{
      font-size: 14px;
      line-height: 1.35;
      margin: 6px 0;
    }
    .bubble__line b{ font-weight: 950; }

    .modal__actions{
      display:flex;
      gap: 10px;
      justify-content: flex-end;
      padding: 12px 14px;
      border-top: 1px solid rgba(13,13,13,.10);
      background: #fff;
    }
    .btn--approve{
      background: rgba(0,180,90,.12);
      border: 1px solid rgba(0,180,90,.25);
      color: rgba(0,120,60,1);
    }
    .btn--approve:hover{ background: rgba(0,180,90,.18); }
    .btn--decline{
      background: rgba(230,50,50,.12);
      border: 1px solid rgba(230,50,50,.25);
      color: rgba(170,20,20,1);
    }
    .btn--decline:hover{ background: rgba(230,50,50,.18); }
    .btn--neutral{
      background: rgba(13,13,13,.06);
      border: 1px solid rgba(13,13,13,.12);
      color: var(--black);
    }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }

    /* ===== Progress Section ===== */
    .section{
      margin-top: 22px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .section__top{
      display:flex;
      justify-content: space-between;
      align-items:flex-end;
      gap: 12px;
      flex-wrap: wrap;
    }
    .section__title{
      margin:0;
      font-weight: 950;
      font-size: 16px;
    }
    .section__sub{
      margin: 4px 0 0;
      font-size: 13px;
      color: var(--muted);
      line-height: 1.35;
      max-width: 760px;
    }

    .users{
      display:flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 12px;
    }
    .user-row{
      border: 1px solid rgba(13,13,13,.12);
      border-radius: 16px;
      padding: 12px;
      display:flex;
      gap: 12px;
      align-items:center;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease;
      background: rgba(13,13,13,.02);
    }
    .user-row:hover{
      transform: translateY(-1px);
      border-color: rgba(13,13,13,.20);
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
      background:#fff;
    }
    .avatar{
      width: 38px; height: 38px;
      border-radius: 14px;
      background: rgba(255,98,0,.16);
      border: 1px solid rgba(255,98,0,.22);
      display:grid;
      place-items:center;
      font-weight: 950;
      color: rgba(13,13,13,.85);
      flex: 0 0 auto;
    }
    .user-main{
      display:flex;
      flex-direction: column;
      gap: 2px;
      min-width: 190px;
    }
    .user-name{
      margin:0;
      font-weight: 950;
      font-size: 14px;
    }
    .user-meta{
      font-size: 12px;
      color: var(--muted);
    }
    .bar-wrap{
      flex: 1 1 auto;
      min-width: 180px;
      display:flex;
      flex-direction: column;
      gap: 6px;
    }
    .bar{
      height: 12px;
      border-radius: 999px;
      background: rgba(13,13,13,.08);
      overflow:hidden;
      border: 1px solid rgba(13,13,13,.10);
    }
    .bar > div{
      height: 100%;
      width: 0%;
      background: rgba(255,98,0,.90);
      border-radius: 999px;
      transition: width .18s ease;
    }
    .bar.is-complete > div{
      background: rgba(0,180,90,.85);
    }
    .bar-line{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      font-size: 12px;
      color: var(--muted);
    }
    .tag{
      font-size: 12px;
      font-weight: 950;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(13,13,13,.12);
      background: rgba(13,13,13,.04);
      white-space: nowrap;
      flex: 0 0 auto;
    }
    .tag.complete{
      background: rgba(0,180,90,.10);
      border-color: rgba(0,180,90,.22);
      color: rgba(0,120,60,1);
    }
    .tag.incomplete{
      background: rgba(255,98,0,.10);
      border-color: rgba(255,98,0,.22);
      color: rgba(140,60,0,1);
    }

    /* ===== User message modal ===== */
    .u-modal.is-hidden{ display:none; }
    .u-modal{
      position: fixed;
      inset:0;
      z-index: 10000;
      display:grid;
      place-items:center;
      padding: 18px;
    }
    .u-modal__overlay{
      position:absolute;
      inset:0;
      background: rgba(0,0,0,.55);
    }
    .u-modal__panel{
      position: relative;
      width: min(520px, 100%);
      border-radius: 18px;
      overflow:hidden;
      background: #fff;
      border: 1px solid rgba(13,13,13,.14);
      box-shadow: 0 24px 70px rgba(0,0,0,.35);
    }
    .u-modal__header{
      background: var(--black);
      color:#fff;
      padding: 12px 14px;
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
    }
    .u-modal__title{
      margin:0;
      font-weight: 950;
      font-size: 16px;
    }
    .u-modal__body{
      padding: 14px;
      display:flex;
      flex-direction: column;
      gap: 10px;
    }
    .note{
      font-size: 13px;
      color: var(--muted);
      line-height: 1.35;
      border: 1px dashed rgba(13,13,13,.18);
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(13,13,13,.02);
    }
    .msg-preview{
      border: 1px solid rgba(13,13,13,.10);
      border-radius: 16px;
      padding: 12px;
      background: rgba(255,98,0,.05);
      font-size: 14px;
      line-height: 1.35;
    }
    .u-modal__actions{
      display:flex;
      gap: 10px;
      justify-content: flex-end;
      padding: 12px 14px;
      border-top: 1px solid rgba(13,13,13,.10);
      background: #fff;
    }
    .btn--orange{
      background: rgba(255,98,0,.16);
      border: 1px solid rgba(255,98,0,.30);
      color: rgba(150,55,0,1);
    }
    .btn--orange:hover{ background: rgba(255,98,0,.22); }
    .btn--green{
      background: rgba(0,180,90,.12);
      border: 1px solid rgba(0,180,90,.25);
      color: rgba(0,120,60,1);
    }
    .btn--green:hover{ background: rgba(0,180,90,.18); }
  </style>
</head>

<body>

  <header class="topbar">
    <div class="topbar__left">
      <button class="btn btn--ghost" type="button" onclick="history.back()">‚Üê Back</button>
    </div>

    <h1 class="topbar__title">HR Portal</h1>

    <div class="topbar__right">
      <div class="pill" id="summaryPill">0 pending</div>
    </div>
  </header>

  <main class="page">
    <div class="header-row">
      <div>
        <h2 class="h2">Edit Profile Requests</h2>
        <p class="sub">
          Click a ticket to review. Approving will update <code>profile_data_v1</code> (what employees see on their Profile page).
        </p>
      </div>

      <div class="filters" aria-label="Filters">
        <button class="filter is-active" data-filter="PENDING" type="button">
          <span class="dot pending"></span> Pending <span id="countPending">(0)</span>
        </button>
        <button class="filter" data-filter="APPROVED" type="button">
          <span class="dot approved"></span> Approved <span id="countApproved">(0)</span>
        </button>
        <button class="filter" data-filter="DECLINED" type="button">
          <span class="dot declined"></span> Declined <span id="countDeclined">(0)</span>
        </button>
        <button class="filter" data-filter="ALL" type="button">
          <span class="dot"></span> All <span id="countAll">(0)</span>
        </button>
      </div>
    </div>

    <section class="grid" id="ticketGrid" aria-label="HR request tickets"></section>

    <div class="empty is-hidden" id="emptyState">
      No tickets found for this filter.
    </div>

    <!-- Progress Section -->
    <section class="section" aria-label="Onboarding progress">
      <div class="section__top">
        <div>
          <h3 class="section__title">Onboarding Progress</h3>
          <p class="section__sub">
            This shows task completion progress by stage. Main user stays on <b>Day 1</b>; dummy users are on different <b>Week</b> stages.
            Click a user to send a check-in message, or send a congratulatory message if they completed their current stage.
          </p>
        </div>
        <div class="pill" id="day1Pill">Stage: ‚Äî</div>
      </div>

      <div class="users" id="progressUsers"></div>
    </section>

  </main>

  <!-- Ticket Modal -->
  <div class="modal is-hidden" id="modal" aria-hidden="true">
    <div class="modal__overlay" id="modalOverlay"></div>

    <div class="modal__panel" role="dialog" aria-label="Ticket details">
      <div class="modal__header">
        <h3 class="modal__title" id="modalTitle">Ticket</h3>
        <button class="icon-btn" id="modalClose" type="button" aria-label="Close">‚úï</button>
      </div>

      <div class="bubble" id="modalBody"></div>

      <div class="modal__actions">
        <button class="btn btn--neutral" id="modalCancel" type="button">Close</button>
        <button class="btn btn--decline" id="modalDecline" type="button">Decline</button>
        <button class="btn btn--approve" id="modalApprove" type="button">Approve</button>
      </div>
    </div>
  </div>

  <!-- User Message Modal -->
  <div class="u-modal is-hidden" id="uModal" aria-hidden="true">
    <div class="u-modal__overlay" id="uOverlay"></div>

    <div class="u-modal__panel" role="dialog" aria-label="Send message">
      <div class="u-modal__header">
        <h3 class="u-modal__title" id="uTitle">User</h3>
        <button class="icon-btn" id="uClose" type="button" aria-label="Close">‚úï</button>
      </div>

      <div class="u-modal__body">
        <div class="note" id="uNote">Select an action below.</div>

        <div class="msg-preview" id="uPreview">
          Message preview will appear here.
        </div>
      </div>

      <div class="u-modal__actions">
        <button class="btn btn--neutral" id="uCancel" type="button">Close</button>
        <button class="btn btn--orange" id="uCheckIn" type="button">Send Check-in</button>
        <button class="btn btn--green" id="uCongrats" type="button" disabled>Send Congrats</button>
      </div>
    </div>
  </div>

<script>
  // =========================================================
  // STORAGE KEYS
  // =========================================================
  const HR_TICKETS_KEY   = "hr_tickets_v1";
  const PROFILE_DATA_KEY = "profile_data_v1";

  const HR_NUDGES_KEY = "hr_homepage_nudges_v1";   // HR -> homepage popups (INBOX)
  const CONGRATS_KEY = "task_completion_congrats_v1";

  // Weekly tasks storage from Weekly Tasks page (main user)
  const WEEKLY_TASKS_KEY = "weekly_tasks_progress_v1";

  // Dummy users stage + progress (HR side)
  const DUMMY_PROGRESS_KEY = "hr_dummy_progress_v2";  // <-- bumped version so your old seed doesn't conflict

  // HR outbox (messages HR "sent")
  const HR_OUTBOX_KEY = "hr_outbox_v1";

  // =========================================================
  // TASK STAGES (from your Weekly Tasks DATA)
  // =========================================================
  const TASK_STAGES = [
    {
      id: "day1",
      title: "Day 1",
      tasks: [
        { id: "d1_t1", title: "Staff pass" },
        { id: "d1_t2", title: "Laptop ready" },
        { id: "d1_t3", title: "Email & Wi-Fi" },
        { id: "d1_t4", title: "Onboarding session" },
        { id: "d1_t5", title: "Office tour" },
      ],
    },
    {
      id: "week1",
      title: "Week 1: Onboarding & Basics",
      tasks: [
        { id: "w1_t1", title: "Training course" },
        { id: "w1_t2", title: "Instagram Drafts" },
        { id: "w1_t3", title: "Festival photos" },
      ],
    },
    {
      id: "week2",
      title: "Week 2: Content Creation Focus",
      tasks: [
        { id: "w2_t1", title: "Tiktok ideas" },
        { id: "w2_t2", title: "Instagram posts" },
        { id: "w2_t3", title: "Video editing" },
        { id: "w2_t4", title: "Research" },
      ],
    },
    {
      id: "week3",
      title: "Week 3: Campaign Support",
      tasks: [
        { id: "w3_t1", title: "Visual editing" },
        { id: "w3_t2", title: "Youth Festival" },
        { id: "w3_t3", title: "Check links/QR codes" },
      ],
    },
    {
      id: "week4",
      title: "Week 4: Reporting & Collaboration",
      tasks: [
        { id: "w4_t1", title: "Social Performance Report" },
        { id: "w4_t2", title: "Feedback" },
        { id: "w4_t3", title: "Talent Showcase Planning" },
        { id: "w4_t4", title: "Participant feedback" },
      ],
    },
  ];

  const STAGE_BY_ID = Object.fromEntries(TASK_STAGES.map(s => [s.id, s]));
  const STAGE_TASK_IDS = (stageId) => (STAGE_BY_ID[stageId]?.tasks || []).map(t => t.id);

  // Main user stays on Day 1
  const MAIN_STAGE_ID = "day1";

  // =========================================================
  // DOM
  // =========================================================
  const grid = document.getElementById("ticketGrid");
  const emptyState = document.getElementById("emptyState");

  const countPending = document.getElementById("countPending");
  const countApproved = document.getElementById("countApproved");
  const countDeclined = document.getElementById("countDeclined");
  const countAll = document.getElementById("countAll");
  const summaryPill = document.getElementById("summaryPill");

  const filterBtns = Array.from(document.querySelectorAll(".filter"));

  // Ticket modal
  const modal = document.getElementById("modal");
  const modalOverlay = document.getElementById("modalOverlay");
  const modalClose = document.getElementById("modalClose");
  const modalCancel = document.getElementById("modalCancel");
  const modalTitle = document.getElementById("modalTitle");
  const modalBody = document.getElementById("modalBody");
  const modalApprove = document.getElementById("modalApprove");
  const modalDecline = document.getElementById("modalDecline");

  // Progress section
  const progressUsersEl = document.getElementById("progressUsers");
  const day1Pill = document.getElementById("day1Pill");

  // User message modal
  const uModal = document.getElementById("uModal");
  const uOverlay = document.getElementById("uOverlay");
  const uClose = document.getElementById("uClose");
  const uCancel = document.getElementById("uCancel");
  const uTitle = document.getElementById("uTitle");
  const uNote = document.getElementById("uNote");
  const uPreview = document.getElementById("uPreview");
  const uCheckIn = document.getElementById("uCheckIn");
  const uCongrats = document.getElementById("uCongrats");

  // =========================================================
  // HELPERS
  // =========================================================
  function loadJSON(key, fallback){
    const raw = localStorage.getItem(key);
    if (!raw) return fallback;
    try { return JSON.parse(raw); } catch { return fallback; }
  }
  function saveJSON(key, val){
    localStorage.setItem(key, JSON.stringify(val));
  }

  function show(el){ el.classList.remove("is-hidden"); el.setAttribute("aria-hidden","false"); }
  function hide(el){ el.classList.add("is-hidden"); el.setAttribute("aria-hidden","true"); }

  function fmtTime(ts){
    const d = new Date(ts);
    return new Intl.DateTimeFormat("en-SG", {
      year:"numeric", month:"short", day:"2-digit",
      hour:"2-digit", minute:"2-digit"
    }).format(d);
  }

  function escapeHTML(s){
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function initials(name){
    const parts = String(name || "").trim().split(/\s+/).filter(Boolean);
    if (!parts.length) return "U";
    const a = parts[0][0] || "U";
    const b = parts.length > 1 ? (parts[parts.length-1][0] || "") : "";
    return (a + b).toUpperCase();
  }

  // Map ticket field label -> profile_data_v1 key
  function fieldToProfileKey(field){
    const f = String(field || "").toLowerCase();
    if (f.includes("user")) return "userId";
    if (f.includes("name")) return "name";
    if (f.includes("dept") || f.includes("department")) return "dept";
    if (f.includes("role")) return "role";
    if (f.includes("contact") || f.includes("email")) return "contact";
    return null;
  }

  // Detect "task completion" tickets (robust)
  function isTaskCompletionTicket(ticket){
    const type = String(ticket?.type || ticket?.category || "").toUpperCase();
    if (type === "TASK_COMPLETION") return true;

    const requestType = String(ticket?.requestType || "").toLowerCase();
    if (requestType.includes("task completion")) return true;

    const field = String(ticket?.change?.field || "").toLowerCase();
    if (field.includes("task completion") || field.includes("weekly task") || field.includes("task")) return true;

    return false;
  }

  function isProfileEditTicket(ticket){
    return !isTaskCompletionTicket(ticket);
  }

  // enqueue congrats popup for that user (homepage reads & shows once)
  function queueCongratsForUser({ userId, name, ticketId }){
    if (!userId) return;

    const list = loadJSON(CONGRATS_KEY, []);
    list.push({
      id: `cg_${Date.now()}_${Math.random().toString(16).slice(2)}`,
      userId,
      name: name || "",
      ticketId: ticketId || "",
      createdAt: Date.now(),
      seenAt: null
    });
    saveJSON(CONGRATS_KEY, list);
  }

  // homepage expects: { id, type, userId, title, message, feedbackLabel?, seenAt:null }
  function pushHomepageNudge({ userId, title, message, type="CHECKIN", feedbackLabel }){
    if (!userId) return;

    const nudges = loadJSON(HR_NUDGES_KEY, []);
    nudges.push({
      id: `NUDGE-${Date.now()}-${Math.random().toString(16).slice(2)}`,
      type,
      userId,
      title: title || "",
      message: message || "",
      feedbackLabel: feedbackLabel || "Message to HR",
      createdAt: Date.now(),
      seenAt: null
    });
    saveJSON(HR_NUDGES_KEY, nudges);
  }

  // =========================================================
  // Main user profile + progress (stays on Day 1)
  // =========================================================
  function getMainUserProfile(){
    const p = loadJSON(PROFILE_DATA_KEY, {});
    return {
      userId: p.userId || "SCAPE_User_67",
      name: p.name || "Jaden Koh",
      dept: p.dept || p.department || "Marketing",
      role: p.role || "Intern",
      contact: p.contact || "jaden.koh@scape.sg | +65 6123 4002",
    };
  }

  function computeMainStageProgress(){
    // main user uses WEEKLY_TASKS_KEY completed map for Day 1
    const s = loadJSON(WEEKLY_TASKS_KEY, null);
    const completed = (s && s.completed) ? s.completed : {};
    const taskIds = STAGE_TASK_IDS(MAIN_STAGE_ID);
    const done = taskIds.filter(id => !!completed[id]).length;
    const total = taskIds.length;
    const pct = total === 0 ? 0 : Math.round((done / total) * 100);
    return {
      stageId: MAIN_STAGE_ID,
      stageTitle: STAGE_BY_ID[MAIN_STAGE_ID]?.title || "Day 1",
      done, total, pct,
      completedIds: taskIds.filter(id => !!completed[id])
    };
  }

  // =========================================================
  // Dummy users: each on a different WEEK stage (not Day 1)
  // We store: { userId, name, dept, role, stageId, done, total, updatedAt }
  // =========================================================
  function seedDummyProgressIfMissing(){
    const existing = loadJSON(DUMMY_PROGRESS_KEY, null);
    if (existing && Array.isArray(existing) && existing.length) return;

    const mk = (userId, name, dept, role, stageId, done) => {
      const total = STAGE_TASK_IDS(stageId).length || 1;
      return { userId, name, dept, role, stageId, done: Math.max(0, Math.min(done, total)), total, updatedAt: Date.now() };
    };

    // ‚úÖ Dummy users are on different WEEKS (week1-week4)
    const seeded = [
      mk("SCAPE_User_12", "Aisha Rahman", "People & Culture", "Associate", "week1", 2),
      mk("SCAPE_User_44", "Marcus Lim", "Creative", "Intern", "week2", 3),
      mk("SCAPE_User_19", "Chloe Tan", "Finance", "Executive", "week3", 1),
      mk("SCAPE_User_77", "Daniel Goh", "Marketing", "Executive", "week4", 4),
    ];

    saveJSON(DUMMY_PROGRESS_KEY, seeded);
  }

  // =========================================================
  // Progress section render (mixed stages)
  // =========================================================
  function renderProgressSection(){
    seedDummyProgressIfMissing();

    const main = getMainUserProfile();
    const mainProg = computeMainStageProgress();

    // pill summarises main user's stage (since they‚Äôre the only Day 1 user)
    day1Pill.textContent = `${mainProg.stageTitle}: ${mainProg.done}/${mainProg.total} completed`;

    const dummy = loadJSON(DUMMY_PROGRESS_KEY, []);
    const merged = [];

    merged.push({
      userId: main.userId,
      name: main.name,
      dept: main.dept,
      role: main.role,
      stageId: mainProg.stageId,
      stageTitle: mainProg.stageTitle,
      done: mainProg.done,
      total: mainProg.total,
      updatedAt: Date.now(),
      isMain: true
    });

    dummy
      .filter(u => u.userId !== main.userId)
      .forEach(u => merged.push({
        ...u,
        stageTitle: STAGE_BY_ID[u.stageId]?.title || u.stageId,
        isMain: false
      }));

    progressUsersEl.innerHTML = "";

    merged.forEach(u => {
      const total = u.total || (STAGE_TASK_IDS(u.stageId).length || 1);
      const done = Math.max(0, Math.min(total, u.done || 0));
      const pct = total === 0 ? 0 : Math.round((done / total) * 100);
      const complete = pct === 100;

      const row = document.createElement("div");
      row.className = "user-row";
      row.tabIndex = 0;

      row.innerHTML = `
        <div class="avatar">${escapeHTML(initials(u.name))}</div>

        <div class="user-main">
          <p class="user-name">
            ${escapeHTML(u.name)}
          </p>
          <div class="user-meta">
            <b>${escapeHTML(u.userId)}</b> ‚Ä¢ ${escapeHTML(u.dept)} ‚Ä¢ ${escapeHTML(u.role)} ‚Ä¢
            <span style="font-weight:950;">${escapeHTML(u.stageTitle)}</span>
          </div>
        </div>

        <div class="bar-wrap">
          <div class="bar ${complete ? "is-complete" : ""}">
            <div style="width:${pct}%;"></div>
          </div>
          <div class="bar-line">
            <span>Progress</span>
            <span><b>${done}/${total}</b> ‚Ä¢ ${pct}%</span>
          </div>
        </div>

        <div class="tag ${complete ? "complete" : "incomplete"}">
          ${complete ? "Completed" : "In progress"}
        </div>
      `;

      row.addEventListener("click", () => openUserModal(u, pct));
      row.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") openUserModal(u, pct);
      });

      progressUsersEl.appendChild(row);
    });
  }

  // =========================================================
  // HR outbox log (optional, for auditing)
  // =========================================================
  function pushOutboxMessage({ toUserId, toName, type, message }){
    const outbox = loadJSON(HR_OUTBOX_KEY, []);
    outbox.unshift({
      id: `msg_${Date.now()}_${Math.random().toString(16).slice(2)}`,
      toUserId,
      toName,
      type,
      message,
      createdAt: Date.now()
    });
    saveJSON(HR_OUTBOX_KEY, outbox);
  }

  function buildCheckInMessage(name, stageTitle){
    const stage = stageTitle || "your onboarding tasks";
    return `Hi ${name || "there"} ‚Äî just checking in on ${stage}. Let us know if you need any help or clarifications. üôÇ`;
  }

  function buildCongratsMessage(name, stageTitle){
    const stage = stageTitle || "your tasks";
    return `Congrats ${name || "there"} üéâ You‚Äôve completed ${stage}. Great work ‚Äî keep it up!`;
  }

  // =========================================================
  // User modal
  // =========================================================
  let selectedUser = null;
  let selectedUserPct = 0;

  function openUserModal(user, pct){
    selectedUser = user;
    selectedUserPct = pct;

    const stageTitle = user.stageTitle || STAGE_BY_ID[user.stageId]?.title || user.stageId || "Tasks";

    uTitle.textContent = `${user.name} ‚Ä¢ ${stageTitle} ‚Ä¢ ${pct}%`;
    uNote.textContent = `Choose an action. "Send Congrats" is only available when this stage is completed (100%).`;

    const checkIn = buildCheckInMessage(user.name, stageTitle);
    uPreview.textContent = checkIn;

    uCongrats.disabled = pct !== 100;

    show(uModal);

    // Send Check-in => pushes homepage nudge
    uCheckIn.onclick = () => {
      const msg = buildCheckInMessage(user.name, stageTitle);

      pushOutboxMessage({
        toUserId: user.userId,
        toName: user.name,
        type: "CHECK_IN",
        message: msg
      });

      pushHomepageNudge({
        userId: user.userId,
        type: `STAGE_CHECKIN_${String(user.stageId || "NA").toUpperCase()}`,
        title: "‚è∞ Progress check-in",
        message: msg,
        feedbackLabel: "Message to HR"
      });

      uPreview.textContent = msg;
      closeUserModal();
    };

    uCongrats.onclick = () => {
      if (pct !== 100) return;

      const msg = buildCongratsMessage(user.name, stageTitle);

      pushOutboxMessage({
        toUserId: user.userId,
        toName: user.name,
        type: "CONGRATS",
        message: msg
      });

      // Existing: congrats popup system (if you want it)
      queueCongratsForUser({
        userId: user.userId,
        name: user.name,
        ticketId: ""
      });

      uPreview.textContent = msg;
      closeUserModal();
    };
  }

  function closeUserModal(){
    selectedUser = null;
    selectedUserPct = 0;
    hide(uModal);
  }

  uOverlay.addEventListener("click", closeUserModal);
  uClose.addEventListener("click", closeUserModal);
  uCancel.addEventListener("click", closeUserModal);

  // =========================================================
  // TICKETS: STATE
  // =========================================================
  let activeFilter = "PENDING";
  let tickets = loadJSON(HR_TICKETS_KEY, []);
  let selectedTicketId = null;

  // =========================================================
  // COUNTS + SUMMARY
  // =========================================================
  function updateCounts(){
    const visible = tickets.filter(isProfileEditTicket);

    const pending  = visible.filter(t => t.status === "PENDING").length;
    const approved = visible.filter(t => t.status === "APPROVED").length;
    const declined = visible.filter(t => t.status === "DECLINED").length;

    countPending.textContent  = `(${pending})`;
    countApproved.textContent = `(${approved})`;
    countDeclined.textContent = `(${declined})`;
    countAll.textContent      = `(${visible.length})`;

    summaryPill.textContent = `${pending} pending`;
  }

  function getFilteredTickets(){
    const visible = tickets.filter(isProfileEditTicket);
    if (activeFilter === "ALL") return visible;
    return visible.filter(t => t.status === activeFilter);
  }

  function render(){
    updateCounts();
    grid.innerHTML = "";

    const list = getFilteredTickets();

    if (!list.length){
      show(emptyState);
    } else {
      hide(emptyState);
    }

    list.forEach(t => {
      const card = document.createElement("div");
      card.className = "card";
      card.tabIndex = 0;

      const statusClass =
        t.status === "PENDING" ? "pending" :
        t.status === "APPROVED" ? "approved" : "declined";

      const who = t.requestedBy?.name || "(unknown)";
      const uid = t.requestedBy?.userId || "(no user)";
      const dept = t.requestedBy?.dept || "";
      const role = t.requestedBy?.role || "";

      const field = t.change?.field || "-";
      const newVal = t.change?.newValue || "-";

      card.innerHTML = `
        <div class="card__top">
          <div class="ticket-id">${escapeHTML(t.id || "Ticket")}</div>
          <div class="status ${statusClass}">${escapeHTML(t.status)}</div>
        </div>

        <p class="who">${escapeHTML(who)}</p>

        <div class="meta">
          <div><b>${escapeHTML(uid)}</b> ‚Ä¢ ${escapeHTML(dept)}${dept && role ? " ‚Ä¢ " : ""}${escapeHTML(role)}</div>
          <div>Submitted: ${t.createdAt ? fmtTime(t.createdAt) : "-"}</div>
        </div>

        <div class="change">
          <div class="change__row"><span class="k">Field</span><span>${escapeHTML(field)}</span></div>
          <div class="change__row"><span class="k">New value</span><span>${escapeHTML(newVal)}</span></div>
        </div>
      `;

      card.addEventListener("click", () => openTicket(t.id));
      card.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") openTicket(t.id);
      });

      grid.appendChild(card);
    });

    renderProgressSection();
  }

  function openTicket(id){
    const t = tickets.find(x => x.id === id);
    if (!t) return;

    if (!isProfileEditTicket(t)) return;

    selectedTicketId = id;

    const who = t.requestedBy?.name || "(unknown)";
    const uid = t.requestedBy?.userId || "(no user)";
    const dept = t.requestedBy?.dept || "-";
    const role = t.requestedBy?.role || "-";
    const contact = t.requestedBy?.contact || "-";

    const field = t.change?.field || "-";
    const newVal = t.change?.newValue || "-";
    const reason = t.change?.reason || "(no reason provided)";

    modalTitle.textContent = `${t.id} ‚Ä¢ ${t.status}`;

    const decidedLine = (t.status !== "PENDING" && t.decidedAt)
      ? `<div class="bubble__line"><b>Decision:</b> ${escapeHTML(t.status)} ‚Ä¢ ${fmtTime(t.decidedAt)}</div>`
      : "";

    modalBody.innerHTML = `
      <div class="bubble__section">
        <div class="bubble__h">Employee</div>
        <div class="bubble__line"><b>Name:</b> ${escapeHTML(who)}</div>
        <div class="bubble__line"><b>User:</b> ${escapeHTML(uid)}</div>
        <div class="bubble__line"><b>Dept / Role:</b> ${escapeHTML(dept)} / ${escapeHTML(role)}</div>
        <div class="bubble__line"><b>Contact:</b> ${escapeHTML(contact)}</div>
      </div>

      <div class="bubble__section">
        <div class="bubble__h">Requested Change</div>
        <div class="bubble__line"><b>Field:</b> ${escapeHTML(field)}</div>
        <div class="bubble__line"><b>New value:</b> ${escapeHTML(newVal)}</div>
        <div class="bubble__line"><b>Reason:</b> ${escapeHTML(reason)}</div>
        <div class="bubble__line"><b>Submitted:</b> ${t.createdAt ? fmtTime(t.createdAt) : "-"}</div>
        ${decidedLine}
      </div>
    `;

    const isPending = t.status === "PENDING";
    modalApprove.disabled = !isPending;
    modalDecline.disabled = !isPending;

    show(modal);
  }

  function closeModal(){
    selectedTicketId = null;
    hide(modal);
  }

  modalOverlay.addEventListener("click", closeModal);
  modalClose.addEventListener("click", closeModal);
  modalCancel.addEventListener("click", closeModal);

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape"){
      closeModal();
      closeUserModal();
    }
  });

  // =========================================================
  // APPROVE / DECLINE
  // =========================================================
  function saveTicketsAndRerender(){
    saveJSON(HR_TICKETS_KEY, tickets);
    render();
  }

  function applyApprovedChangeToProfile(ticket){
    const key = fieldToProfileKey(ticket.change?.field);
    if (!key) return;

    const profile = loadJSON(PROFILE_DATA_KEY, {});
    profile[key] = ticket.change?.newValue || profile[key];
    saveJSON(PROFILE_DATA_KEY, profile);
  }

  modalApprove.addEventListener("click", () => {
    const t = tickets.find(x => x.id === selectedTicketId);
    if (!t || t.status !== "PENDING") return;

    t.status = "APPROVED";
    t.decidedAt = Date.now();

    applyApprovedChangeToProfile(t);

    saveTicketsAndRerender();
    closeModal();
  });

  modalDecline.addEventListener("click", () => {
    const t = tickets.find(x => x.id === selectedTicketId);
    if (!t || t.status !== "PENDING") return;

    t.status = "DECLINED";
    t.decidedAt = Date.now();

    saveTicketsAndRerender();
    closeModal();
  });

  filterBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      filterBtns.forEach(b => b.classList.remove("is-active"));
      btn.classList.add("is-active");
      activeFilter = btn.dataset.filter || "PENDING";
      render();
    });
  });

  render();
</script>

</body>
</html>
